# Neo4j查询工具 - 技术分析文档

## 项目概述

**项目名称**: neo4j_query Dify Plugin  
**版本**: 0.0.1  
**类型**: Dify工具插件  
**作者**: Nikola Milosevic  
**创建时间**: 2025-06-12

这是一个专为Dify.ai平台设计的Neo4j图数据库集成工具，旨在通过Dify工作流或智能体实现对Neo4j图数据库的无缝访问和查询功能。

## 核心功能

### 主要特性
1. **直接Cypher查询**: 支持向Neo4j Aura实例或URL部署的Neo4j数据库发送原生Cypher查询语句
2. **图数据库集成**: 专门针对知识图谱应用、推荐系统、搜索和数据分析场景设计
3. **LLM友好**: 支持将数据库模式上下文集成到基于LLM的工作流中
4. **隐私保护**: 所有数据传输仅限于指定的Neo4j实例，不向第三方发送用户数据

### 应用场景
- 知识图谱查询和探索
- 图数据库驱动的推荐系统
- 复杂关系数据的搜索和分析
- 自然语言到Cypher查询的转换

## 技术架构

### 项目结构
```
dify_neo4j/
├── _assets/
│   └── icon.svg                    # 插件图标
├── provider/
│   ├── neo4j_query.py             # 提供者实现
│   └── neo4j_query.yaml           # 提供者配置
├── tools/
│   ├── neo4j_query.py             # 工具核心实现
│   └── neo4j_query.yaml           # 工具配置
├── main.py                        # 插件入口文件
├── manifest.yaml                  # 插件清单文件
├── requirements.txt               # Python依赖
├── README.md                      # 项目说明
├── PRIVACY.md                     # 隐私政策
└── GUIDE.md                       # 开发指南
```

### 核心组件分析

#### 1. 插件入口 (`main.py`)
```python
from dify_plugin import Plugin, DifyPluginEnv

plugin = Plugin(DifyPluginEnv(MAX_REQUEST_TIMEOUT=120))

if __name__ == '__main__':
    plugin.run()
```
- 设置120秒的最大请求超时时间
- 初始化并运行Dify插件环境

#### 2. 提供者类 (`provider/neo4j_query.py`)
```python
class Neo4jQueryProvider(ToolProvider):
    def _validate_credentials(self, credentials: dict[str, Any]) -> None:
        url = credentials.get("AURA_URL")
        username = credentials.get("AURA_USERNAME") 
        password = credentials.get("AURA_PASSWORD")
        # 验证连接凭据的完整性和有效性
```

**功能职责**:
- 验证Neo4j连接凭据的完整性
- 测试数据库连接的可用性
- 提供统一的凭据管理接口

#### 3. 查询工具类 (`tools/neo4j_query.py`)
```python
class Neo4jQueryTool(Tool):
    def _invoke(self, tool_parameters: dict[str, Any]) -> Generator[ToolInvokeMessage]:
        # 获取连接凭据
        url = self.runtime.credentials.get("AURA_URL")
        username = self.runtime.credentials.get("AURA_USERNAME")
        password = self.runtime.credentials.get("AURA_PASSWORD")
        query = tool_parameters.get("query")
        
        # 执行Cypher查询并返回结果
```

**核心功能**:
- 接收用户的Cypher查询语句
- 建立与Neo4j数据库的连接
- 执行查询并处理结果
- 返回JSON格式和文本格式的查询结果

### 配置系统

#### 插件清单配置 (`manifest.yaml`)
```yaml
version: 0.0.1
type: plugin
author: nikola_milosevic
name: neo4j_query
resource:
  memory: 268435456  # 256MB内存限制
  permission:
    tool:
      enabled: true
    endpoint:
      enabled: true
    app:
      enabled: true
    storage:
      enabled: true
      size: 1048576    # 1MB存储空间
```

#### 凭据配置
插件需要三个必需的凭据参数：
- **AURA_URL**: Neo4j Aura连接URL（格式：`neo4j+s://xxxx.databases.neo4j.io`）
- **AURA_USERNAME**: 数据库用户名（通常为`neo4j`）
- **AURA_PASSWORD**: 数据库密码（安全输入类型）

#### 工具参数
- **query**: Cypher查询语句（字符串类型，必需参数）

## 技术特点

### 优势
1. **简单易用**: 只需配置连接凭据，即可直接执行Cypher查询
2. **多语言支持**: 支持英语、中文、日语、葡萄牙语界面
3. **安全性**: 采用基础认证机制，支持SSL连接
4. **集成性**: 与Dify平台无缝集成，支持工作流和智能体调用
5. **轻量级**: 依赖简洁，仅需`dify_plugin`和`neo4j`两个核心包

### 技术限制
1. **查询复杂度**: 对于大型知识图谱，复杂的自然语言到Cypher的转换可能需要额外的上下文处理
2. **错误处理**: 当前的错误处理相对简单，可能需要更详细的错误分类和处理
3. **性能优化**: 没有查询缓存或连接池机制

## 最佳实践建议

### 使用建议
1. **提供模式上下文**: 在使用智能体时，建议将图数据库的模式信息作为上下文传递给LLM
2. **分步查询策略**: 对于复杂查询，建议先生成相关子图，再执行最终的Cypher语句
3. **查询优化**: 合理使用索引和限制条件，避免全图扫描

### 安全考虑
1. **凭据管理**: 确保Neo4j凭据的安全存储和传输
2. **查询权限**: 建议为插件使用专门的数据库用户，限制其权限范围
3. **数据隐私**: 所有查询数据仅在用户指定的Neo4j实例和Dify平台之间传输

## 部署和使用

### 安装步骤
1. 安装Dify插件开发脚手架
2. 打包插件：`./dify plugin package dify_neo4j`
3. 上传插件到Dify实例
4. 配置Neo4j连接凭据
5. 在工作流或智能体中使用

### 运行环境要求
- **Python版本**: 3.12
- **架构支持**: AMD64, ARM64
- **内存要求**: 最大256MB
- **Dify版本**: 兼容最新版本

## 隐私和安全

### 数据处理原则
- **最小化原则**: 仅处理执行查询所需的最少数据
- **透明性**: 所有数据流向明确，仅限于用户指定的Neo4j实例
- **无存储**: 不保存连接凭据、查询内容或查询结果
- **无第三方传输**: 除Neo4j Aura外，不向任何第三方服务传输数据

### 用户控制
- 用户可随时断开插件连接
- 连接信息仅存储在用户的Dify配置中
- 支持即时终止数据库会话

## 总结

Neo4j查询工具是一个专业、轻量级的Dify插件，专门为图数据库查询场景设计。它提供了简洁的接口来连接和查询Neo4j数据库，特别适合知识图谱应用和复杂关系数据的分析场景。插件在设计上注重隐私保护和安全性，是构建图数据库驱动的AI应用的理想选择。

通过合理的使用策略和最佳实践，该工具可以有效地将Neo4j的强大图查询能力集成到Dify的智能工作流中，为用户提供高效的图数据库访问体验。
